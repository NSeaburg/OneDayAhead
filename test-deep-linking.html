<!DOCTYPE html>
<html>
<head>
    <title>Test LTI Deep Linking</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; }
        button { padding: 10px 20px; margin: 10px 0; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>LTI 1.3 Deep Linking Test</h1>
    
    <div class="test-section">
        <h2>1. Test Content Package Scanning</h2>
        <button onclick="testContentScan()">Scan Content Packages</button>
        <div id="scanResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Deep Linking Interface</h2>
        <p>This simulates the Canvas teacher selecting content for their course.</p>
        <button onclick="openDeepLinking()">Open Deep Linking Interface</button>
        <div id="deepLinkResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Assignment Config Storage</h2>
        <button onclick="testAssignmentConfig()">Test Assignment Storage</button>
        <div id="configResult" class="result"></div>
    </div>

    <script>
        async function testContentScan() {
            try {
                const response = await fetch('/api/content/packages');
                const data = await response.json();
                document.getElementById('scanResult').innerHTML = `
                    <h3>Found ${data.packages.length} content packages:</h3>
                    <ul>
                        ${data.packages.map(pkg => `
                            <li><strong>${pkg.name}</strong> (${pkg.id})<br>
                            Bot: ${pkg.assessmentBot.name}<br>
                            Description: ${pkg.description}</li>
                        `).join('')}
                    </ul>
                `;
            } catch (error) {
                document.getElementById('scanResult').innerHTML = `Error: ${error.message}`;
            }
        }

        function openDeepLinking() {
            // Create a mock deep linking request
            const mockDeepLinkData = {
                deep_link_return_url: 'https://test.canvas.com/api/lti/deep_linking',
                data: 'test-data-123',
                deployment_id: '1:1234567890'
            };
            
            // Open deep linking interface in new window
            const params = new URLSearchParams(mockDeepLinkData);
            const deepLinkUrl = `/api/lti/deep-linking?${params.toString()}`;
            
            // Since we can't do a proper POST from here, let's simulate the interface
            document.getElementById('deepLinkResult').innerHTML = `
                <p>In a real Canvas environment, this would open the content selection interface.</p>
                <p><a href="${deepLinkUrl}" target="_blank">Open Deep Linking Interface (simulation)</a></p>
                <p><strong>Note:</strong> The actual interface requires proper LTI authentication context.</p>
            `;
        }

        async function testAssignmentConfig() {
            try {
                // Test creating an assignment config
                const testConfig = {
                    platformId: 1,
                    contextId: 'test-context-123',
                    resourceLinkId: 'test-resource-456',
                    contentPackageId: 'demo-district/civics-government/three-branches',
                    district: 'demo-district',
                    course: 'civics-government',
                    topic: 'three-branches',
                    config: { test: true }
                };

                const response = await fetch('/api/lti/assignment-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('configResult').innerHTML = `
                        <h3>Assignment Config Test: SUCCESS</h3>
                        <p>Config ID: ${result.id}</p>
                        <p>Content Package: ${result.contentPackageId}</p>
                    `;
                } else {
                    const error = await response.text();
                    document.getElementById('configResult').innerHTML = `
                        <h3>Assignment Config Test: FAILED</h3>
                        <p>Error: ${error}</p>
                    `;
                }
            } catch (error) {
                document.getElementById('configResult').innerHTML = `
                    <h3>Assignment Config Test: ERROR</h3>
                    <p>${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>